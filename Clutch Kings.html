<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clutch Kings</title>
  <style>
    /* ... (no changes to the CSS, reuse your current style) ... */
    /* CSS omitted for brevity; copy your full CSS here as above */
  </style>
</head>
<body>
<main>
  <h1>Clutch Kings</h1>
  <section id="instructions" aria-live="polite" tabindex="0">
    Press the <strong>spacebar</strong> to shift gears when your dot is centered on a checkpoint circle.<br>
    Time your shifts well for a speed boost. Missing a shift gives a slowdown, but you can recover.<br>
    <u>New:</u> Press <kbd>P</kbd> to pause/resume. Press <kbd>R</kbd> to restart.<br>
    The leaderboard tracks your best times and win streaks!
  </section>
  <form aria-label="Game controls" style="margin-bottom:0;">
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty" aria-label="Select game difficulty">
      <option value="very_easy">Very Easy</option>
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
      <option value="very_hard">Very Hard</option>
    </select>
    <button type="button" id="startButton" aria-label="Start Race">Start Race</button>
  </form>
  <div id="countdown" aria-live="polite"></div>
  <div id="gameArea" tabindex="0" aria-label="Game Area"></div>
  <div id="leaderboard" aria-live="polite"></div>
  <div id="fastestTimeDisplay"></div>
  <div id="streakDisplay"></div>
</main>
<script defer>
  // --- Constants & Globals ---
  const TRACK_LEFT = 30;
  const TRACK_RIGHT = 1140;
  const TRACK_TOP = 60;
  const TRACK_HEIGHT = 60;
  const DOT_SIZE = 20;
  const TOTAL_CHECKPOINTS = 5;
  const TOTAL_PLAYERS = 6;
  const CPU_ACCURACY_BASE = [0.027, 0.035, 0.043, 0.050, 0.060, 0.070]; // for linear track
  const colors = ["red", "blue", "green", "yellow", "orange", "purple"];
  let winStreak = 0, bestTime = null, ghostDot = null, paused = false;

  // Game state
  let playerDots = [],
      speeds = [],
      intervals = [],
      shifts = [],
      checkpoints = [],
      leaderboard = [],
      cpuAccuracy = [],
      perfectStreak = [],
      shiftLabels = [],
      progress = [],
      startTime, raceEnded = false,
      difficultyMultiplier = 1,
      pauseIntervals = [],
      ghostInterval = null;

  // --- Accessibility helper ---
  function focusInstructions() {
    const inst = document.getElementById('instructions');
    inst.setAttribute('tabindex', '0');
    inst.focus();
  }

  // --- Difficulty ---
  function setDifficulty() {
    const diff = document.getElementById("difficulty").value;
    if (diff === "very_easy") difficultyMultiplier = 0.6;
    else if (diff === "easy") difficultyMultiplier = 0.8;
    else if (diff === "medium") difficultyMultiplier = 1.0;
    else if (diff === "hard") difficultyMultiplier = 1.2;
    else difficultyMultiplier = 1.4;
  }

  // --- Checkpoints: evenly spaced with minimum spacing ---
  function generateRandomCheckpoints() {
    checkpoints = [];
    const minSpacing = 0.15; // Minimum spacing between checkpoints (adjust as needed)
    let attempts = 0;
    while (checkpoints.length < TOTAL_CHECKPOINTS && attempts < 500) {
      let candidate = Math.random() * 0.84 + 0.08;
      if (checkpoints.every(cp => Math.abs(cp - candidate) > minSpacing)) {
        checkpoints.push(candidate);
      }
      attempts++;
    }
    // If not enough unique ones could be placed, fill remaining with even spacing
    if (checkpoints.length < TOTAL_CHECKPOINTS) {
      checkpoints = [];
      for (let i = 0; i < TOTAL_CHECKPOINTS; i++) {
        checkpoints.push(0.08 + i * (0.84 / (TOTAL_CHECKPOINTS - 1)));
      }
    }
    checkpoints.sort((a, b) => a - b);
  }

  // --- Drawing Functions (no changes) ---
  // ... (drawCheckpointCircles, drawFlatTrack, drawFinishLine: keep as in your original)

  // --- Game Start (no changes except uses new checkpoint generation) ---

  // --- Key Handling: Space (shift), P (pause) ---
  let lastKeyPress = 0;
  function handleKeyPress(e) {
    // Pause/Resume
    if (e.key === 'p' || e.key === 'P') {
      paused = !paused;
      if (paused) {
        pauseIntervals = intervals.map(clearInterval);
        clearGhostInterval();
        showFeedback('Paused', 'miss');
      } else {
        for (let i = 0; i < TOTAL_PLAYERS; i++) {
          intervals[i] = setInterval(() => moveDot(i), 50);
        }
        if (ghostDot && bestTime) createGhostDot();
        showFeedback('Resumed', 'success');
      }
      return;
    }
    // Space = shift (debounced)
    if ((e.code === "Space" || e.key === " ") && !paused && Date.now() - lastKeyPress > 180) {
      lastKeyPress = Date.now();
      const i = 0; // User = player 1
      if (shifts[i] < TOTAL_CHECKPOINTS) {
        const dist = Math.abs(progress[i] - checkpoints[shifts[i]]);
        // --- Tighter shift windows ---
        if (dist < 0.015) {  // Perfect: 0.015 (very tight)
          perfectStreak[i]++;
          speeds[i] += 1.5 * difficultyMultiplier + 0.1 * perfectStreak[i];
          playerDots[i].style.filter = "blur(2px) brightness(1.4)";
          flashDot(playerDots[i]);
          shiftLabels[i].textContent = "Perfect!";
          shiftLabels[i].className = "shift-label perfect";
          setTimeout(() => shiftLabels[i].textContent = "", 650);
          playSound('perfect');
          shifts[i]++;
        } else if (dist < 0.035) { // Okay: 0.035 (also tight, but wider than perfect)
          perfectStreak[i] = 0;
          speeds[i] += 0.5 * difficultyMultiplier;
          playerDots[i].style.filter = "";
          flashDot(playerDots[i], "#ff0");
          shiftLabels[i].textContent = "Okay";
          shiftLabels[i].className = "shift-label okay";
          setTimeout(() => shiftLabels[i].textContent = "", 550);
          playSound('okay');
          shifts[i]++;
        } else {
          perfectStreak[i] = 0;
          playerDots[i].style.filter = "";
          shiftLabels[i].textContent = "Miss!";
          shiftLabels[i].className = "shift-label miss";
          setTimeout(() => shiftLabels[i].textContent = "", 700);
          playSound('miss');
          showFeedback('Missed! Try again.', 'miss');
        }
      }
    }
  }

  // --- Dot Movement (linear) ---
  // ... rest of the functions as in your original code ...

  // --- Paste the rest of your JS functions below, unchanged, from your current file. ---
  // (drawCheckpointCircles, drawFlatTrack, drawFinishLine, startGame, startRace, moveDot, clearIntervalAll, clearGhostInterval, updateLeaderboard, createGhostDot, showFeedback, flashDot, playSound, saveBestTime, loadBestTime, event listeners)
  // For brevity, they are not repeated here since they are unchanged.

  // --- At the end, reconnect event listeners ---
  document.getElementById("startButton").addEventListener("click", startGame);
  window.addEventListener("DOMContentLoaded", () => {
    focusInstructions();
    loadBestTime();
  });
  window.addEventListener('keydown', function(e) {
    if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "SELECT" || document.activeElement.tagName === "TEXTAREA") return;
    if (e.key === 'r' || e.key === 'R') {
      startGame();
    }
  });
</script>
</body>
</html>
