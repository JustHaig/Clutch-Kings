<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clutch Kings</title>
  <style>
    :root {
      --track-height: 60px;
      --dot-size: 20px;
    }
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #111;
      color: #eee;
      height: 100%;
      width: 100%;
      min-height: 100vh;
    }
    main {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    h1 {
      margin-top: 24px;
      margin-bottom: 12px;
    }
    #instructions {
      font-size: 1rem;
      margin: 10px auto;
      width: 80%;
      line-height: 1.5;
      color: #e0e0e0;
      background: #181818;
      border-radius: 8px;
      padding: 10px 12px;
    }
    label, select, button {
      font-size: 16px;
      margin: 10px 4px;
      padding: 5px 10px;
    }
    #countdown {
      font-size: 2em;
      margin-top: 20px;
    }
    #leaderboard {
      margin-top: 10px;
      font-size: 14px;
      display: none;
      background: #232323;
      border-radius: 8px;
      padding: 10px 16px;
      color: #fff;
      max-width: 350px;
      word-break: break-all;
    }
    #fastestTimeDisplay, #streakDisplay {
      margin-top: 5px;
      font-size: 14px;
      color: #ccc;
    }
    #gameArea {
      margin-top: 30px;
      position: relative;
      height: 420px;
      width: 1200px;
      max-width: 98vw;
      overflow: hidden;
      border-top: 2px solid #444;
      border-bottom: 2px solid #444;
      background: #131313;
      outline: none;
    }
    .dot {
      position: absolute;
      width: var(--dot-size);
      height: var(--dot-size);
      border-radius: 50%;
      transition: filter 0.3s, box-shadow 0.2s;
      box-shadow: none;
      outline: none;
    }
    .red { background: red; }
    .blue { background: blue; }
    .green { background: green; }
    .yellow { background: yellow; }
    .orange { background: orange; }
    .purple { background: purple; }
    .checkpoint-circle {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background-color: #ccc;
      position: absolute;
      z-index: 3;
      border: 2px solid #111;
      box-shadow: 0 0 7px #fff8;
      transform: translate(-50%, -50%);
    }
    .finish-line {
      position: absolute;
      width: 7px;
      height: 380px;
      background: #fff;
      z-index: 2;
      left: 1140px;
      top: 20px;
      border-radius: 2px;
      box-shadow: 0 0 7px #fff8;
    }
    .flat-track-svg {
      position: absolute;
      left: 0; top: 0;
      width: 1200px; height: 420px;
      z-index: 0;
      pointer-events: none;
    }
    .shift-label {
      position: absolute;
      color: #0f0;
      font-size: 13px;
      z-index: 11;
      left: 0px;
      padding: 2px 5px;
      pointer-events: none;
      user-select: none;
      border-radius: 4px;
      min-width: 50px;
      text-align: center;
    }
    .shift-label.perfect { color: #0f0; background: #222; }
    .shift-label.okay { color: #ff0; background: #333; }
    .shift-label.miss { color: #f55; background: #311; }
    .feedback {
      position: fixed;
      left: 50%;
      top: 30px;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      padding: 10px 28px;
      border-radius: 8px;
      z-index: 10000;
      opacity: 0.97;
      font-size: 1.3em;
      box-shadow: 0 3px 18px #0009;
      pointer-events: none;
      animation: feedbackFade 1.1s cubic-bezier(0.4,0,0.2,1);
    }
    .feedback.success { background: #194; color: #fff; }
    .feedback.miss { background: #a31; color: #fff; }
    @keyframes feedbackFade {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    @media (max-width: 1300px) {
      #gameArea, .flat-track-svg { width: 99vw !important; }
    }
    @media (max-width: 700px) {
      #gameArea { height: 180px; width: 100vw !important;}
      .flat-track-svg { height: 180px !important; width: 99vw !important; }
      .dot { width: 12px; height: 12px; }
      .checkpoint-circle { width: 9px; height: 9px; }
      #instructions { font-size: 13px; }
    }
    @media (max-width: 500px) {
      #instructions { width: 99%; font-size: 12px;}
      #leaderboard { font-size: 12px; padding: 7px; }
      .shift-label { font-size: 11px; }
    }
  </style>
</head>
<body>
<main>
  <h1>Clutch Kings</h1>
  <section id="instructions" aria-live="polite" tabindex="0">
    Press the <strong>spacebar</strong> to shift gears when your dot is centered on a checkpoint circle.<br>
    Time your shifts well for a speed boost. Missing a shift gives a slowdown, but you can recover.<br>
    <u>New:</u> Press <kbd>P</kbd> to pause/resume. Press <kbd>R</kbd> to restart.<br>
    The leaderboard tracks your best times and win streaks!
  </section>
  <form aria-label="Game controls" style="margin-bottom:0;">
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty" aria-label="Select game difficulty">
      <option value="very_easy">Very Easy</option>
      <option value="easy">Easy</option>
      <option value="medium" selected>Medium</option>
      <option value="hard">Hard</option>
      <option value="very_hard">Very Hard</option>
    </select>
    <button type="button" id="startButton" aria-label="Start Race">Start Race</button>
  </form>
  <div id="countdown" aria-live="polite"></div>
  <div id="gameArea" tabindex="0" aria-label="Game Area"></div>
  <div id="leaderboard" aria-live="polite"></div>
  <div id="fastestTimeDisplay"></div>
  <div id="streakDisplay"></div>
</main>
<script defer>
  // --- Constants & Globals ---
  const TRACK_LEFT = 30;
  const TRACK_RIGHT = 1140;
  const TRACK_TOP = 60;
  const TRACK_HEIGHT = 60;
  const DOT_SIZE = 20;
  const TOTAL_CHECKPOINTS = 5;
  const TOTAL_PLAYERS = 6;
  const CPU_ACCURACY_BASE = [0.027, 0.035, 0.043, 0.050, 0.060, 0.070]; // for linear track
  const colors = ["red", "blue", "green", "yellow", "orange", "purple"];
  let winStreak = 0, bestTime = null, ghostDot = null, paused = false;

  // Game state
  let playerDots = [],
      speeds = [],
      intervals = [],
      shifts = [],
      checkpoints = [],
      leaderboard = [],
      cpuAccuracy = [],
      perfectStreak = [],
      shiftLabels = [],
      progress = [],
      startTime, raceEnded = false,
      difficultyMultiplier = 1,
      pauseIntervals = [],
      ghostInterval = null;

  // --- Accessibility helper ---
  function focusInstructions() {
    const inst = document.getElementById('instructions');
    inst.setAttribute('tabindex', '0');
    inst.focus();
  }

  // --- Difficulty ---
  function setDifficulty() {
    const diff = document.getElementById("difficulty").value;
    if (diff === "very_easy") difficultyMultiplier = 0.6;
    else if (diff === "easy") difficultyMultiplier = 0.8;
    else if (diff === "medium") difficultyMultiplier = 1.0;
    else if (diff === "hard") difficultyMultiplier = 1.2;
    else difficultyMultiplier = 1.4;
  }

  // --- Checkpoints: random progress values between 0.08 and 0.92 (sorted) ---
  function generateRandomCheckpoints() {
    checkpoints = [];
    for (let i = 0; i < TOTAL_CHECKPOINTS; i++) {
      checkpoints.push(Math.random() * 0.84 + 0.08);
    }
    checkpoints.sort((a, b) => a - b);
  }

  // --- Drawing Functions ---
  function drawCheckpointCircles() {
    const gameArea = document.getElementById("gameArea");
    Array.from(gameArea.querySelectorAll('.checkpoint-circle')).forEach(e => e.remove());
    for (let i = 0; i < TOTAL_PLAYERS; i++) {
      checkpoints.forEach(progress => {
        const x = TRACK_LEFT + progress * (TRACK_RIGHT - TRACK_LEFT);
        const y = TRACK_TOP + i * TRACK_HEIGHT;
        const circle = document.createElement("div");
        circle.className = "checkpoint-circle";
        circle.style.left = `${x}px`;
        circle.style.top = `${y}px`;
        circle.setAttribute("aria-label", `Checkpoint for player ${i+1}`);
        gameArea.appendChild(circle);
      });
    }
  }

  function drawFlatTrack() {
    let svg = document.querySelector('.flat-track-svg');
    if (svg) svg.remove();
    const width = 1200, height = 420;
    const svgNS = "http://www.w3.org/2000/svg";
    svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("class", "flat-track-svg");
    svg.setAttribute("width", width);
    svg.setAttribute("height", height);
    for (let i = 0; i < TOTAL_PLAYERS; i++) {
      const y = TRACK_TOP + i * TRACK_HEIGHT;
      const line = document.createElementNS(svgNS, "line");
      line.setAttribute("x1", TRACK_LEFT);
      line.setAttribute("y1", y);
      line.setAttribute("x2", TRACK_RIGHT);
      line.setAttribute("y2", y);
      line.setAttribute("stroke", "#444");
      line.setAttribute("stroke-width", "8");
      svg.appendChild(line);
    }
    document.getElementById("gameArea").appendChild(svg);
  }

  function drawFinishLine() {
    const gameArea = document.getElementById("gameArea");
    let finish = document.querySelector('.finish-line');
    if (finish) finish.remove();
    finish = document.createElement('div');
    finish.className = 'finish-line';
    finish.style.left = `${TRACK_RIGHT-2.5}px`;
    finish.style.top = `20px`;
    finish.style.height = `${TRACK_HEIGHT * TOTAL_PLAYERS + 20}px`;
    gameArea.appendChild(finish);
  }

  // --- Game Start ---
  function startGame() {
    if (ghostDot) ghostDot.remove();
    clearIntervalAll();
    clearGhostInterval();
    playerDots = []; speeds = []; intervals = []; shifts = []; cpuAccuracy = []; perfectStreak = []; shiftLabels = [];
    progress = [];
    for (let i = 0; i < TOTAL_PLAYERS; i++) {
      speeds.push(1); shifts.push(0); perfectStreak.push(0);
      cpuAccuracy.push(i === 0 ? CPU_ACCURACY_BASE[0] : CPU_ACCURACY_BASE[i] + Math.random() * 0.04);
      progress.push(0);
    }
    raceEnded = false;
    document.getElementById("leaderboard").style.display = "none";
    generateRandomCheckpoints();
    if (bestTime) createGhostDot();
    setDifficulty();

    // Game area setup
    const gameArea = document.getElementById("gameArea");
    gameArea.innerHTML = "";
    gameArea.setAttribute('tabindex', '0');
    gameArea.focus();

    drawFlatTrack();
    drawFinishLine();

    // Add tracks and dots
    for (let i = 0; i < TOTAL_PLAYERS; i++) {
      const x = TRACK_LEFT;
      const y = TRACK_TOP + i * TRACK_HEIGHT;
      const dot = document.createElement("div");
      dot.classList.add("dot", colors[i % colors.length]);
      dot.style.left = `${x}px`;
      dot.style.top = `${y}px`;
      dot.setAttribute("tabindex", "-1");
      dot.setAttribute("aria-label", `Player ${i+1} token`);
      dot.style.zIndex = 10;
      gameArea.appendChild(dot);
      playerDots.push(dot);
      // Shift label
      const label = document.createElement("div");
      label.className = "shift-label";
      label.style.left = `${x}px`;
      label.style.top = `${y-10}px`;
      label.textContent = "";
      gameArea.appendChild(label);
      shiftLabels.push(label);
    }
    drawCheckpointCircles();

    // Countdown
    let countdown = 3;
    document.getElementById("countdown").textContent = countdown;
    const countdownInterval = setInterval(() => {
      if (paused) return;
      countdown--;
      if (countdown === 0) {
        clearInterval(countdownInterval);
        document.getElementById("countdown").textContent = "Go!";
        setTimeout(() => document.getElementById("countdown").textContent = "", 600);
        startRace();
      } else {
        document.getElementById("countdown").textContent = countdown;
      }
    }, 1000);
  }

  // --- Race Start ---
  function startRace() {
    startTime = Date.now();
    raceEnded = false;
    paused = false;
    document.addEventListener("keydown", handleKeyPress, {capture: true});
    for (let i = 0; i < TOTAL_PLAYERS; i++) {
      intervals.push(setInterval(() => moveDot(i), 50));
    }
  }

  // --- Key Handling: Space (shift), P (pause) ---
  let lastKeyPress = 0;
  function handleKeyPress(e) {
    // Pause/Resume
    if (e.key === 'p' || e.key === 'P') {
      paused = !paused;
      if (paused) {
        pauseIntervals = intervals.map(clearInterval);
        clearGhostInterval();
        showFeedback('Paused', 'miss');
      } else {
        for (let i = 0; i < TOTAL_PLAYERS; i++) {
          intervals[i] = setInterval(() => moveDot(i), 50);
        }
        if (ghostDot && bestTime) createGhostDot();
        showFeedback('Resumed', 'success');
      }
      return;
    }
    // Space = shift (debounced)
    if ((e.code === "Space" || e.key === " ") && !paused && Date.now() - lastKeyPress > 180) {
      lastKeyPress = Date.now();
      const i = 0; // User = player 1
      if (shifts[i] < TOTAL_CHECKPOINTS) {
        const dist = Math.abs(progress[i] - checkpoints[shifts[i]]);
        if (dist < 0.03) {
          perfectStreak[i]++;
          speeds[i] += 1.5 * difficultyMultiplier + 0.1 * perfectStreak[i];
          playerDots[i].style.filter = "blur(2px) brightness(1.4)";
          flashDot(playerDots[i]);
          shiftLabels[i].textContent = "Perfect!";
          shiftLabels[i].className = "shift-label perfect";
          setTimeout(() => shiftLabels[i].textContent = "", 650);
          playSound('perfect');
          shifts[i]++;
        } else if (dist < 0.07) {
          perfectStreak[i] = 0;
          speeds[i] += 0.5 * difficultyMultiplier;
          playerDots[i].style.filter = "";
          flashDot(playerDots[i], "#ff0");
          shiftLabels[i].textContent = "Okay";
          shiftLabels[i].className = "shift-label okay";
          setTimeout(() => shiftLabels[i].textContent = "", 550);
          playSound('okay');
          shifts[i]++;
        } else {
          perfectStreak[i] = 0;
          playerDots[i].style.filter = "";
          shiftLabels[i].textContent = "Miss!";
          shiftLabels[i].className = "shift-label miss";
          setTimeout(() => shiftLabels[i].textContent = "", 700);
          playSound('miss');
          showFeedback('Missed! Try again.', 'miss');
        }
      }
    }
  }

  // --- Dot Movement (linear) ---
  function moveDot(i) {
    if (paused || raceEnded) return;
    const dot = playerDots[i];
    // Move progress forward based on speed
    progress[i] += speeds[i] * 0.0012 * difficultyMultiplier; // adjust step as needed
    if (progress[i] > 1) progress[i] = 1;
    // Linear position
    const x = TRACK_LEFT + progress[i] * (TRACK_RIGHT - TRACK_LEFT);
    const y = TRACK_TOP + i * TRACK_HEIGHT;
    dot.style.left = `${x}px`;
    dot.style.top = `${y}px`;
    shiftLabels[i].style.left = `${x}px`;
    shiftLabels[i].style.top = `${y - 10}px`;
    // CPU shifting for AI
    if (i !== 0 && shifts[i] < TOTAL_CHECKPOINTS) {
      const checkpoint = checkpoints[shifts[i]];
      const diff = Math.abs(progress[i] - checkpoint);
      if (diff < cpuAccuracy[i]) {
        speeds[i] += 1.5 * difficultyMultiplier;
        flashDot(dot);
        shifts[i]++;
      }
    }
    // Finish line
    if (progress[i] >= 1 && !raceEnded) {
      raceEnded = true;
      clearIntervalAll();
      clearGhostInterval();
      document.removeEventListener("keydown", handleKeyPress, {capture: true});
      const time = ((Date.now() - startTime) / 1000).toFixed(2);
      const winner = colors[i % colors.length];
      setTimeout(() => alert(`Player ${i + 1} (${winner}) wins in ${time}s!`), 50);
      updateLeaderboard(winner, time);
    }
  }

  function clearIntervalAll() {
    intervals.forEach(clearInterval);
    intervals = [];
  }
  function clearGhostInterval() {
    if (ghostInterval) { clearInterval(ghostInterval); ghostInterval = null; }
    if (ghostDot) { ghostDot.style.left = '0px'; }
  }

  // --- Leaderboard, Streak, Best Time ---
  function updateLeaderboard(player, time) {
    if (player === colors[0]) {
      if (!bestTime || parseFloat(time) < bestTime) {
        bestTime = parseFloat(time);
        saveBestTime(bestTime);
        document.getElementById("fastestTimeDisplay").textContent = `â± Fastest Time Ever: ${bestTime}s`;
      }
    }
    leaderboard.push({ player, time });
    leaderboard.sort((a, b) => parseFloat(a.time) - parseFloat(b.time));
    let output = '<strong>Race Results:</strong><br>';
    leaderboard.slice(0, 6).forEach((entry, idx) => {
      output += `${idx + 1}. ${entry.player} - ${entry.time}s<br>`;
    });
    output += '<br><strong>Perfect Shifts:</strong><br>';
    for (let i = 0; i < TOTAL_PLAYERS; i++) {
      output += `Player ${i + 1} (${colors[i % colors.length]}): ${shifts[i]} / ${TOTAL_CHECKPOINTS}<br>`;
    }
    if (player === colors[0]) {
      winStreak++;
    } else {
      winStreak = 0;
    }
    const lb = document.getElementById("leaderboard");
    lb.innerHTML = output;
    lb.style.display = "block";
    document.getElementById("streakDisplay").textContent = `ðŸ† Win Streak: ${winStreak}`;
  }

  // --- Ghost Dot (Best Time Tracker) ---
  function createGhostDot() {
    if (!bestTime) return;
    if (ghostDot) ghostDot.remove();
    const ghost = document.createElement("div");
    ghost.className = "dot";
    ghost.style.background = "rgba(255,255,255,0.4)";
    ghost.style.top = "0px";
    ghost.style.left = "0px";
    ghost.style.zIndex = 1;
    ghost.setAttribute("aria-label", "Ghost Dot (best time)");
    document.getElementById("gameArea").appendChild(ghost);
    ghostDot = ghost;
    const totalDuration = bestTime * 1000;
    const start = Date.now();
    ghostInterval = setInterval(() => {
      if (paused) return;
      const now = Date.now();
      const prog = Math.min((now - start) / totalDuration, 1);
      const x = TRACK_LEFT + prog * (TRACK_RIGHT - TRACK_LEFT);
      const y = TRACK_TOP;
      ghost.style.left = `${x}px`;
      ghost.style.top = `${y}px`;
      if (prog >= 1) {
        clearGhostInterval();
      }
    }, 16);
  }

  // --- UI Feedback, Sound ---
  function showFeedback(message, type) {
    const feedback = document.createElement('div');
    feedback.textContent = message;
    feedback.className = `feedback ${type}`;
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 1100);
  }
  function flashDot(dot, color = "#fff") {
    dot.style.boxShadow = `0 0 20px 5px ${color}`;
    setTimeout(() => dot.style.boxShadow = "none", 150);
  }
  function playSound(type) {
    // Uncomment and provide valid mp3 files to use sound effects
    // let src = '';
    // if (type === 'perfect') src = 'perfect.mp3';
    // else if (type === 'miss') src = 'miss.mp3';
    // else src = 'okay.mp3';
    // if (src) {
    //   const audio = new Audio(src);
    //   audio.volume = 0.15;
    //   audio.play();
    // }
  }

  // --- Save/Load Best Time ---
  function saveBestTime(time) {
    try { localStorage.setItem('clutchKingsBestTime', time); } catch (e) {}
  }
  function loadBestTime() {
    try {
      const t = localStorage.getItem('clutchKingsBestTime');
      if (t) bestTime = parseFloat(t);
      if (bestTime) document.getElementById("fastestTimeDisplay").textContent = `â± Fastest Time Ever: ${bestTime}s`;
    } catch (e) {}
  }

  // --- Event Listeners ---
  document.getElementById("startButton").addEventListener("click", startGame);
  window.addEventListener("DOMContentLoaded", () => {
    focusInstructions();
    loadBestTime();
  });

  // --- Make "R" restart work globally, even outside active race ---
  window.addEventListener('keydown', function(e) {
    if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "SELECT" || document.activeElement.tagName === "TEXTAREA") return;
    if (e.key === 'r' || e.key === 'R') {
      startGame();
    }
  });

</script>
</body>
</html>
